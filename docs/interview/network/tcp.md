# TCP

TCP（Transmission Control Protocol 传输控制协议）是一个**面向连接的**、**可靠的**、**基于字节流**的传输层通信协议

::: tip TCP 连接

TCP 连接是用于保证可靠性和流量控制维护的某些状态信息的组合，这些信息包括 Socket、序列号和窗口大小

- **Socket**：由 IP 地址和端口号组成
- **序列号**：用来解决乱序问题等
- **窗口大小**：用来做流量控制

:::

::: tip TCP 四元组

- 源地址
- 源端口
- 目的地址
- 目的端口

TCP 四元组可以唯一的确定一个连接

:::

##### 如何唯一确定一个 TCP 连接

## 三次握手

> TCP 连接建立

**三次握手**是指在建立一个 TCP 连接时客户端和服务器总共要**发送 3 个数据包以确认连接的建立**

三次握手的过程如下图所示：

![TCP 三次握手](./images/tcp-three-handshakes.png)

最开始时客户端和服务器都处于 `CLOSED` 状态。然后服务器主动监听某个端口（此时处于 `LISTEN` 状态）

### 第一次握手

> **由客户端发起**

客户端会随机初始化一个序列号（`client_isn`）然后发送一个带有 `SYN` `seq = client_isn` 信息的数据包。发送完成后客户端进入 `SYN_SEND` 状态（连接发送状态）

- `SYN` 是一个标志位，为 1 时表示希望建立连接
- `seq = client_isn` 是客户端随机初始化的序列号（一个 32 位的无符号数）

### 第二次握手

> **由服务器发起**

服务器收到客户端的 `SYN` 报文后，首先会随机初始化自己的序列号（`server_isn`）然后发送一个带有 `SYN` `ACK` `seq = server_isn` `ack = client_isn + 1` 信息的数据包。发送完成后服务器进入 `SYN_RCVD` 状态（连接收到状态）

- `ACK` 是一个标志位，表示收到了请求
- `seq = server_isn` 是服务器随机初始化的序列号（一个 32 位的无符号数）
- `ack = client_isn + 1` 是一个确认应答号，值为**客户端序列号 + 1**

### 第三次握手

> **由客户端发起**

客户端收到服务器报文后，会再发送一个带有 `ACK` `ack = server_isn + 1` 信息的数据包。发送完成后客户端进入 `ESTABLISHED` 状态（连接成功状态）服务器收到客户端发送的应答报文包后也会进入 `ESTABLISHED` 状态

- `ack = server_isn + 1` 是一个确认应答号，值为**服务器序列号 + 1**

::: tip 三次握手可以保证客户端和服务器能够确认双方的接收和发送能力是否正常

- 第一次握手：客户端发送 `SYN` 报文给服务器，服务器接收该报文
  - 客户端什么都不能确认
  - 服务器确认：自己接收正常，对方发送正常
- 第二次握手：服务器发送 `SYN + ACK` 报文给客户端，客户端接收该报文
  - 客户端确认：自己发送正常、接收正常，对方发送正常、接收正常
  - 服务器确认：自己接收正常，对方发送正常
- 第三次握手：客户端发送 `ACK` 报文给服务器
  - 客户端在第二次握手时已经完成确认
  - 服务器确认：自己发送正常，接收正常，对方发送正常、接收正常

:::

##### 三次握手的作用？

1. 防止旧的重复连接初始化造成混乱
2. 同步双方初始序列号（序列号能够保证数据包不重复、不丢弃和按序传输）
3. 避免资源浪费

##### 为什么不是两次握手?

两次握手无法防止历史连接的建立，会造成双方资源的浪费，也无法可靠的同步双方序列号

##### 为什么不是四次握手?

因为通过前三次已经可以建立一个可靠的连接，如果再发送第四次确认消息会浪费资源，所以不需要使用更多的通信次数
